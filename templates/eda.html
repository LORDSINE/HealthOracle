{% extends "base.html" %}

{% block title %}EDA - Health Oracle{% endblock %}

{% block page_class %}dashboard-layout{% endblock %}

{% block nav_eda %}active{% endblock %}

{% block user_avatar %}{{ user_name[0] if user_name else 'U' }}{% endblock %}
{% block user_name %}{{ user_name or 'User' }}{% endblock %}
{% block user_id %}{{ user_id }}{% endblock %}

{% block content %}
<div class="eda-wrapper">
    <!-- Header -->
    <div class="eda-header">
        <h1>Exploratory Data Analysis</h1>
        <p>Comprehensive analysis of the health dataset</p>
    </div>

    <!-- Dataset Overview Card -->
    <div class="content-card" style="margin-bottom: 2rem;">
        <h3 style="font-weight: 500; color: #333; margin-bottom: 1.5rem;">üìä Dataset Overview</h3>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Total Records</div>
                <div class="stat-value">Loading...</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Features</div>
                <div class="stat-value">Loading...</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Target Variable</div>
                <div class="stat-value" style="font-size: 1.2rem; word-break: break-word;">Heart Disease</div>
                <div class="stat-subtitle">(HeartDiseaseorAttack)</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Missing Values</div>
                <div class="stat-value">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Analysis Sections -->
    <div class="content-card" style="margin-bottom: 2rem;">
        <h3 style="font-weight: 500; color: #333; margin-bottom: 1.5rem;">üîç Analysis Categories</h3>
        
        <div class="analysis-grid">
            <div class="analysis-card">
                <div class="analysis-icon">üìà</div>
                <h4>Target Distribution</h4>
                <p>Heart disease class balance and distribution analysis</p>
                <button class="btn-analysis" onclick="showSection('target')">View Analysis</button>
            </div>

            <div class="analysis-card">
                <div class="analysis-icon">üìä</div>
                <h4>Numerical Features</h4>
                <p>Distribution, statistics, and outlier detection</p>
                <button class="btn-analysis" onclick="showSection('numerical')">View Analysis</button>
            </div>

            <div class="analysis-card">
                <div class="analysis-icon">üéØ</div>
                <h4>Categorical Features</h4>
                <p>Binary and categorical variable distributions</p>
                <button class="btn-analysis" onclick="showSection('categorical')">View Analysis</button>
            </div>

            <div class="analysis-card">
                <div class="analysis-icon">üîó</div>
                <h4>Correlations</h4>
                <p>Feature relationships and correlation matrix</p>
                <button class="btn-analysis" onclick="showSection('correlation')">View Analysis</button>
            </div>

            <div class="analysis-card">
                <div class="analysis-icon">‚ö†Ô∏è</div>
                <h4>Risk Factor Analysis</h4>
                <p>Multiple risk factors and disease rate analysis</p>
                <button class="btn-analysis" onclick="showSection('risk')">View Analysis</button>
            </div>

            <div class="analysis-card">
                <div class="analysis-icon">üî¨</div>
                <h4>Statistical Tests</h4>
                <p>Chi-square tests and significance analysis</p>
                <button class="btn-analysis" onclick="showSection('stats')">View Analysis</button>
            </div>
        </div>
    </div>

    <!-- Placeholder for analysis results -->
    <div id="analysisResults" class="content-card" style="display: none;">
        <h3 style="font-weight: 500; color: #333; margin-bottom: 1.5rem;">Analysis Results</h3>
        <div id="resultsContent">
            <!-- Dynamic content will be loaded here -->
        </div>
    </div>

    <!-- Run Full Analysis Button -->
    <div class="eda-action-center">
        <button class="btn btn-gradient" onclick="runFullAnalysis()" style="padding: 0.75rem 2.5rem; font-size: 1rem;">
            üöÄ Run Full EDA Analysis
        </button>
        <p>This will execute the complete EDA pipeline and generate all visualizations</p>
    </div>

    <!-- Academic Note -->
    <div class="content-card eda-note" style="margin-top: 2rem;">
        <p>
            <strong>üìå Note:</strong> This EDA analysis uses the health_data_clean(1).csv dataset. 
            The analysis includes distribution plots, correlation analysis, statistical tests, and risk factor assessment.
            All visualizations are generated using matplotlib, seaborn, and plotly libraries.
        </p>
    </div>
</div>

<script>
// Load dataset overview on page load
document.addEventListener('DOMContentLoaded', function() {
    loadOverview();
});

function loadOverview() {
    fetch('/api/eda/overview')
        .then(response => response.json())
        .then(data => {
            document.querySelectorAll('.stat-value')[0].textContent = data.total_records.toLocaleString();
            document.querySelectorAll('.stat-value')[1].textContent = data.features;
            document.querySelectorAll('.stat-value')[3].textContent = data.missing_values;
        })
        .catch(error => {
            console.error('Error loading overview:', error);
        });
}

function showSection(section) {
    const resultsDiv = document.getElementById('analysisResults');
    const contentDiv = document.getElementById('resultsContent');
    
    resultsDiv.style.display = 'block';
    contentDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner"></div><p>Loading analysis...</p></div>';
    
    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
    
    let endpoint = '';
    let title = '';
    
    switch(section) {
        case 'target':
            endpoint = '/api/eda/target';
            title = 'üìà Target Distribution Analysis';
            break;
        case 'numerical':
            endpoint = '/api/eda/numerical';
            title = 'üìä Numerical Features Analysis';
            break;
        case 'categorical':
            endpoint = '/api/eda/categorical';
            title = 'üéØ Categorical Features Analysis';
            break;
        case 'correlation':
            endpoint = '/api/eda/correlation';
            title = 'üîó Correlation Analysis';
            break;
        case 'risk':
            endpoint = '/api/eda/risk';
            title = '‚ö†Ô∏è Risk Factor Analysis';
            break;
        case 'stats':
            endpoint = '/api/eda/stats';
            title = 'üî¨ Statistical Tests';
            break;
    }
    
    fetch(endpoint)
        .then(response => response.json())
        .then(data => {
            displayResults(data, title, section);
        })
        .catch(error => {
            contentDiv.innerHTML = `<div class="error-message">Error loading analysis: ${error.message}</div>`;
        });
}

function displayResults(data, title, section) {
    const contentDiv = document.getElementById('resultsContent');
    let html = `<h3 style="margin-bottom: 1.5rem;">${title}</h3>`;
    
    // Handle numerical section separately (new structure)
    if (section === 'numerical' && data.stats_summary) {
        // Section 1: Statistical Summary Table
        html += `
            <div class="eda-section">
                <h4 class="section-title">üìä Section 1: Statistical Summary</h4>
                <p class="section-desc">Central tendency and variability of numerical health indicators.</p>
                <div class="table-responsive">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Mean</th>
                                <th>Median</th>
                                <th>Std Dev</th>
                                <th>Min</th>
                                <th>Max</th>
                                <th>Skewness</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        data.stats_summary.forEach(item => {
            html += `
                <tr>
                    <td><strong>${item.feature}</strong></td>
                    <td>${item.mean}</td>
                    <td>${item.median}</td>
                    <td>${item.std}</td>
                    <td>${item.min}</td>
                    <td>${item.max}</td>
                    <td>${item.skewness}</td>
                </tr>
            `;
        });
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        // Section 2: Distribution Plots
        html += `
            <div class="eda-section">
                <h4 class="section-title">üìà Section 2: Distribution Analysis</h4>
                <p class="section-desc">Histogram with KDE showing distribution of key features (BMI, Age, General Health). Red dashed line = Mean, Green solid line = Median.</p>
                <div class="chart-container">
                    <img src="${data.charts.distribution}" alt="Distribution Plots" />
                </div>
            </div>
        `;
        
        // Section 3: Outlier Detection
        html += `
            <div class="eda-section">
                <h4 class="section-title">üîç Section 3: Outlier Detection</h4>
                <p class="section-desc">Boxplots reveal outliers and skewness, important for model robustness. Percentage shows outlier proportion in each feature.</p>
                <div class="chart-container">
                    <img src="${data.charts.outliers}" alt="Outlier Detection" />
                </div>
            </div>
        `;
        
        // Section 4: Numerical Features vs Target
        html += `
            <div class="eda-section">
                <h4 class="section-title">üéØ Section 4: Features vs Heart Disease</h4>
                <p class="section-desc">Violin plots show distribution and density comparison between patients with and without heart disease. This is the most important analysis for understanding feature impact.</p>
                <div class="chart-container">
                    <img src="${data.charts.vs_target}" alt="Features vs Target" />
                </div>
            </div>
        `;
        
        // Section 5: Correlation with Target
        html += `
            <div class="eda-section">
                <h4 class="section-title">üìä Section 5: Correlation with Target</h4>
                <p class="section-desc">Correlation analysis identifies the most influential numerical predictors. Red bars = positive correlation (increases risk), Green bars = negative correlation (decreases risk).</p>
                <div class="chart-container">
                    <img src="${data.charts.correlation}" alt="Correlation Analysis" />
                </div>
                <div class="correlation-summary">
                    <h5>Top Correlations:</h5>
                    <div class="correlation-badges">
        `;
        data.correlations.slice(0, 5).forEach(item => {
            const colorClass = item.correlation > 0 ? 'positive' : 'negative';
            html += `<span class="corr-badge ${colorClass}">${item.feature}: ${item.correlation}</span>`;
        });
        html += `
                    </div>
                </div>
            </div>
        `;
        
        contentDiv.innerHTML = html;
        return;
    }
    
    // Display statistics if available (for other sections)
    if (data.stats) {
        html += '<div class="stats-container">';
        
        if (section === 'target') {
            html += `
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-box">
                        <div class="stat-label">No Disease</div>
                        <div class="stat-value">${data.stats.no_disease.toLocaleString()} (${data.stats.no_disease_pct}%)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Disease</div>
                        <div class="stat-value stat-value--danger">${data.stats.disease.toLocaleString()} (${data.stats.disease_pct}%)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Imbalance Ratio</div>
                        <div class="stat-value">${data.stats.imbalance_ratio}:1</div>
                    </div>
                </div>
            `;
        } else if (section === 'categorical') {
            html += '<table class="stats-table"><thead><tr><th>Feature</th><th>No (0)</th><th>Yes (1)</th></tr></thead><tbody>';
            data.stats.forEach(item => {
                html += `<tr>
                    <td><strong>${item.feature}</strong></td>
                    <td>${item.no_count.toLocaleString()} (${item.no_pct}%)</td>
                    <td>${item.yes_count.toLocaleString()} (${item.yes_pct}%)</td>
                </tr>`;
            });
            html += '</tbody></table>';
        } else if (section === 'risk') {
            html += '<table class="stats-table"><thead><tr><th>Risk Factors</th><th>Disease Rate</th><th>Sample Count</th></tr></thead><tbody>';
            data.stats.forEach(item => {
                html += `<tr>
                    <td><strong>${item.RiskFactorCount}</strong></td>
                    <td>${item.DiseaseRate}%</td>
                    <td>${item.Count.toLocaleString()}</td>
                </tr>`;
            });
            html += '</tbody></table>';
        }
        
        html += '</div>';
    }
    
    // Display correlation data
    if (data.top_correlations) {
        html += '<div style="margin: 1.5rem 0;"><h4>Top Correlations with Heart Disease</h4>';
        html += '<table class="stats-table"><thead><tr><th>Feature</th><th>Correlation</th></tr></thead><tbody>';
        data.top_correlations.features.slice(0, 10).forEach((feature, idx) => {
            const value = data.top_correlations.values[idx];
            const colorClass = value > 0 ? 'correlation-positive' : 'correlation-negative';
            html += `<tr><td><strong>${feature}</strong></td><td class="${colorClass}">${value}</td></tr>`;
        });
        html += '</tbody></table></div>';
    }
    
    // Display chi-square tests
    if (data.chi_square_tests) {
        html += '<div style="margin: 1.5rem 0;"><h4>Chi-Square Test Results</h4>';
        html += '<table class="stats-table"><thead><tr><th>Feature</th><th>Chi¬≤</th><th>p-value</th><th>Cram√©r\'s V</th><th>Significant</th></tr></thead><tbody>';
        data.chi_square_tests.forEach(test => {
            html += `<tr>
                <td><strong>${test.feature}</strong></td>
                <td>${test.chi2}</td>
                <td>${test.p_value}</td>
                <td>${test.cramers_v}</td>
                <td>${test.significant}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        html += '<p style="margin-top: 1rem; font-size: 0.875rem; color: #666;"><em>Cram√©r\'s V Interpretation: 0.1=Small, 0.3=Medium, 0.5=Large effect</em></p></div>';
    }
    
    // Display charts (can be single chart or array of charts)
    if (data.chart) {
        html += '<div class="chart-container"><img src="' + data.chart + '" /></div>';
    }
    
    if (data.charts && Array.isArray(data.charts)) {
        data.charts.forEach((chart, idx) => {
            html += '<div class="chart-container"><img src="' + chart + '" /></div>';
        });
    }
    
    contentDiv.innerHTML = html;
}

function runFullAnalysis() {
    if (confirm('This will load all analysis sections one by one. Continue?')) {
        const sections = ['target', 'numerical', 'categorical', 'correlation', 'risk', 'stats'];
        let index = 0;
        
        function loadNext() {
            if (index < sections.length) {
                showSection(sections[index]);
                index++;
                setTimeout(loadNext, 1000);
            }
        }
        
        loadNext();
    }
}
</script>
{% endblock %}
